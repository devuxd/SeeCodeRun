<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ACE and Esprima in Action!</title>
<script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.2.3/ace.js" type="text/javascript" charset="utf-8"></script>
<!-- Init Scripts for Execution Trace API !-->
<script src="./scripts/esprima.js" type="text/javascript" charset="utf-8"></script>
<script src="./scripts/escodegen.browser.js" type="text/javascript" charset="utf-8"></script>
<script src="./scripts/esmorph.js" type="text/javascript" charset="utf-8"></script>
<script src="./scripts/executiontrace.js" type="text/javascript" charset="utf-8"></script>
<!-- End Scripts for Execution Trace API !-->

<style type="text/css" media="screen">
    #editor { 
        position: absolute;
        top: 0;
        right: 0;
        bottom: 0;
        left: 0;
    }
	
	#info{
		position:absolute;
		background-color: #F55;
		border-radius: 1px;
		top: 20px;
		left: 610px;
		width: 200px;
		z-index: 101;		
	}
	#stacktrace{
		position:absolute;
		background-color: #FF9;
		border-radius: 1px;
		top: 40px;
		left: 610px;
		width: auto;
		bottom: auto;
		z-index: 100;		
	}
	.seecoderun_tooltip {
		background-color: #FFF;
		background-image: -webkit-linear-gradient(top, transparent, rgba(0, 0, 0, 0.1));
		background-image: linear-gradient(to bottom, transparent, rgba(0, 0, 0, 0.1));
		border: 1px solid gray;
		border-radius: 1px;
		box-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
		color: black;
		max-width: 100%;
		padding: 3px 4px;
		position: absolute;
		z-index: 999998;
		-moz-box-sizing: border-box;
		-webkit-box-sizing: border-box;
		box-sizing: border-box;
		cursor: default;
		white-space: pre;
		word-wrap: break-word;
		line-height: normal;
		font-style: normal;
		font-weight: normal;
		letter-spacing: normal;
		pointer-events: none;
	}
</style>
</head>
<body>
<pre id="editor">
Array.prototype.swap = function (i, j) {
    var k = this[i]; this[i] = this[j]; this[j] = k;
};

function bubbleSort(list) {
    var items = list.slice(0), swapped = false, p, q;
    for (p = 1; p < items.length; ++p) {
        for (q = 0; q < items.length - p; ++q) {
            if (items[q + 1] < items[q]) {
                items.swap(q, q + 1);
                swapped =true;
            }
        }
        if (!swapped) break;
    }
    return items;
}

var N = 5, data = []; while (N > 0) data.push(N--);
bubbleSort(data);
var x = { c :  N};
x.c++;
delete x.c;

var c= false, d= [];
var i, n=5;

if(c){
    var x=7;
}else{
    
}

while(c){
    var notused= 8;
}

do{

}while(c);
for(i=0; i < 5; i++){

}

for( var x in c){
}

//issue 17

var y =7, z = 49;
var x = (y * 7) / z;

</pre>
<div id="info" >Ready.</div>
<div id="stacktrace" >None</div>
<script>
	// initiating the editor
    var editor = ace.edit("editor");
    editor.setTheme("ace/theme/monokai");
    editor.getSession().setMode("ace/mode/javascript");
	editor.renderer.setShowGutter(true);
	editor.session.setOption("useWorker", false);
    
    //Esprima
    // done: prepare demo from http://esprima.org/demo/functiontrace.html into this one 
    // done: look the required statements in the tree
    // todo: instrument the log of issue 16 [pending to catch the expression statement parent so code can be appended]
    // todo: collect the stack trace [ populate tree with callstack sequences]
    var canTrace = true;
    var traceAnnotations =[];
    window.onload = function () {
        'use strict';
        canTrace=true;
        window.CANTRACE =true;
    	
        document.getElementById('info').setAttribute('class', 'alert-box secondary');
        document.getElementById('info').innerHTML = 'Ready.';
        
    	var executionTrace = JSON.parse(localStorage.getItem('executionTrace'));
    	if(executionTrace){
    	    visualize(executionTrace.stackTrace);
    	}
    	
    	setTimeout(function(){  canTrace = true;}, 3000);
    	
    	var aceDocumentForEsprima = editor.getSession().getDocument(); // get the document for changes in its structure
    	aceDocumentForEsprima.on("change", function(e){
    	    var sourceCode = aceDocumentForEsprima.getValue(); // get the code to analyze
    	    // API CALL
    	    if(canTrace){
    	    	window.traceExecution(sourceCode, eventListener);
    	        canTrace = false;
    	        setTimeout(function(){  canTrace = true;}, 3000);
    	    }
    	     showTraceAnnotations(editor);
    	});
    // 	editor.getSession().on("changeAnnotation", function(e){
    //         showTraceAnnotations(editor);
    // 	});
    
    };
    
    // update the status of the trace run
    function eventListener (event){
        if(event.status === "Running"){
            document.getElementById('info').setAttribute('class', 'alert-box secondary');
            document.getElementById('info').innerHTML = event.description;
    		document.getElementById('stacktrace').innerHTML = 'Waiting...';        
        }else if(event.status === "Finished"){
            traceAnnotations = window.getTraceAnnotations();
            showTraceAnnotations(editor);
            
            document.getElementById('info').setAttribute('class', 'alert-box secondary');
            document.getElementById('info').innerHTML = event.description;
            var stackTrace = window.TRACE.getStackTrace();
            var valueTable = window.TRACE.getExecutionTrace();
            var executionTrace = {'stackTrace' : stackTrace, 'valueTable' : valueTable};
            localStorage.setItem('executionTrace', JSON.stringify(executionTrace));
    		document.getElementById('stacktrace').innerHTML ='LOCAL CALL STACK:<br>'+ visualize(stackTrace)+'<br>EXECUTION TRACE:<br>';
    		
    	 $('#stacktrace').append(visualizeExecutionTrace(valueTable)); 
    	 
        }else if(event.status === "Error"){
            document.getElementById('info').innerHTML = event.description;
            document.getElementById('info').setAttribute('class', 'alert-box alert');
            document.getElementById('stacktrace').innerHTML = 'Waiting...';
        }else if(event.status === "Timeout"){
            document.getElementById('info').innerHTML = event.description;
            document.getElementById('info').setAttribute('class', 'alert-box alert');
            document.getElementById('stacktrace').innerHTML = 'Waiting...';
        }else if(event.status === "Busy"){
            document.getElementById('info').innerHTML = event.description;
            document.getElementById('info').setAttribute('class', 'alert-box alert');
            document.getElementById('stacktrace').innerHTML = 'Busy, please wait...';
        }
    }
    
    // example using ACE Annotations
    function showTraceAnnotations(aceEditor) {
            var annotations = aceEditor.getSession().getAnnotations();	
            annotations= annotations.concat(traceAnnotations);
    		aceEditor.getSession().setAnnotations(annotations);
    }
    
    // example of how to use the trace resulting data structure
    function visualize(stackTrace){
        var i, entry, name, index;
        var stackText= "";
    	var repeat = 0;
    	var previousCall = "";
    	var previousIndex = -1;
        for (i = 0; i < stackTrace.length; i += 1) {
            entry = stackTrace[i];
            if(entry){
                name = entry.text;
        		index = entry.index;
        		 if(previousCall !== name){				 
        			 if(repeat > 0){
        				 stackText += previousIndex + " -- " + previousCall + "( + "+ repeat +" times) <br>";
        				 repeat = 0;
        			 }else{
        				 if(previousIndex > -1){
        					 stackText += previousIndex + " -- " + previousCall + "<br> ";
        				 }
        				 
        			 }
        			 previousCall = name;
        			 previousIndex = index;
        		 }else{
        			 repeat = repeat + 1; 
        		 }
            }
    		
        }
    	if(repeat > 0){
    		stackText +=  previousIndex + " -- " + previousCall + "( + "+ repeat +" times )";
    		repeat = 0;
    	}else{
    		if(previousIndex > -1){
    			stackText += previousIndex + " -- " + previousCall ;
    		}					 
    	}
    	
    	return stackText;  
    
    }
     // example of how to use the trace resulting data structure
    function visualizeExecutionTrace(executionTrace){
        var i, entry;
        var stackText= "";

        for (i = 0; i < executionTrace.length; i += 1) {
            entry = executionTrace[i];
            stackText += i + " -- " + JSON.stringify(entry) + "<br> ";
           
        }
       
    	
    	return stackText;  
    
    }
    
    function isPositioninRange(position, inRange){
        
        var matchesInOneLine = (
                position.row == inRange.start.row 
                && inRange.start.row  == inRange.end.row
                && position.column >= inRange.start.column
                && position.column <= inRange.end.column
            );
            
        if(matchesInOneLine){
            return true;
        }
            
        var matchesStart = (
                position.row == inRange.start.row 
                && inRange.start.row  < inRange.end.row
                && position.column >= inRange.start.column
            );
           
        if(matchesStart){
            return true;
        }
        
        var matchesEnd = (
                position.row == inRange.end.row
                && inRange.start.row  < inRange.end.row
                && position.column <= inRange.end.column
            );

        return matchesEnd;

    }
    function isRangeInRange(isRange, inRange){
        return (
                (isRange.start.row >= inRange.start.row && isRange.start.column >= inRange.start.column)
    			 &&
    			(isRange.end.row <= inRange.end.row && isRange.end.column <= inRange.end.column)
    			);
    }
    function isRangeInRangeStrict(isRange, inRange){
        return (
                (isRange.start.row >= inRange.start.row && isRange.start.column > inRange.start.column)
    			 &&
    			(isRange.end.row <= inRange.end.row && isRange.end.column < inRange.end.column)
    			);
    }
    
    editor.on("mousemove", function (e){
		var position = e.getDocumentPosition(),  hasUpdate =false, data, match;
		if(position){ 
		//console.log("mouse " + position.row + ", " + position.column);
		//	var wordRange = editor.getSession().getWordRange(position.row , position.column);
			var result = window.TRACE? window.TRACE.getExecutionTrace() : undefined;
			if(!result){
			    return;
			}
			
			for(var key in result){
			    data = result[key];
			    
    			 if(data.range && isPositioninRange(position, data.range)){
    			     if(match){
    			         if(isRangeInRangeStrict(data.range, match.range)){
    			             match = data;
    			         }
    			     }else{
    			        match = data;
    			     }
    			 
    			 }
			}
			if(match){
    				var pixelPosition = editor.renderer.textToScreenCoordinates(match.range.start);
    				pixelPosition.pageY += editor.renderer.lineHeight;
    				updateTooltip(pixelPosition, match.text +",  values"+ JSON.stringify(match.values));
    		}else{
    				updateTooltip(editor.renderer.textToScreenCoordinates(position));
    		}
			
		}
		});
		
		function updateTooltip(position, text){
			//example with container creation via JS
			var div = document.getElementById('tooltip_0');
			if(div === null){
				div = document.createElement('div');		
				div.setAttribute('id', 'tooltip_0'); 
				div.setAttribute('class', 'seecoderun_tooltip'); // and make sure myclass has some styles in css
				document.body.appendChild(div);
			}

			div.style.left = position.pageX + 'px';
			div.style.top = position.pageY + 'px';
			if(text){
				div.style.display = "block";
				div.innerText = text;
			}else{
				div.style.display = "none";
				div.innerText = "";
			}			
			
		}

</script>
</body>
</html>